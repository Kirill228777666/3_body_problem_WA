<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Симулятор трёх тел</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  
  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(','\\)']], displayMath: [['\\[','\\]']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  
  <style>
    /* ИСПРАВЛЕНО: Добавлены стили для корректного переключения иконок */
    /* Добавлено !important для принудительного применения правил display */
    .mass-icon-circle { display: none !important; }
    .is-circles-mode .mass-icon-image { display: none !important; }
    .is-circles-mode .mass-icon-circle { display: inline-block !important; }
    .mass-circle {
      display: inline-block;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(0,0,0,0.35);
      vertical-align: middle;
    }
    .as-circle {
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(0,0,0,0.35);
    }
    .is-circles-mode .ThreeBodyProblem-bodyImage { display: none !important; }

    .approximation-display-style {
      background-color: rgba(28, 37, 65, 0.7);
      padding: 15px 20px;
      margin: 10px auto 0 auto;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      max-width: 700px;
      color: #f0f0f0;
    }
    .approximation-display-style h4 {
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 600;
    }
    .approximation-display-style pre {
      font-family: monospace;
      font-size: 1.1em;
      text-align: left;
      margin: 10px auto;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      white-space: pre-wrap;
    }
    #formula-text-0 { color: #ff8b22; }
    #formula-text-1 { color: #6c81ff; }
    #formula-text-2 { color: #4ccd7a; }
  </style>

</head>
<body>

  <div id="loader-wrapper">
    <div class="loader">
      <div class="inner one"></div>
      <div class="inner two"></div>
      <div class="inner three"></div>
    </div>
    <div class="loader">
      <div class="inner one"></div>
      <div class="inner two"></div>
      <div class="inner three"></div>
    </div>
  </div>

  <h1>Симулятор трёх тел</h1>
  <p id="ThreeBodyProblem-notSupportedMessage" class="ThreeBodyProblem-alert ThreeBodyProblem-isHiddenBlock">
    Пожалуйста, используйте современный браузер для просмотра симуляции.
  </p>
  <div class="ThreeBodyProblem-container isFullScreenWide isUnselectable">
    <div class="ThreeBodyProblem-sun">
      <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/sun.png" class="ThreeBodyProblem-spin ThreeBodyProblem-bodyImage" alt="Солнце" />
    </div>
    <div class="ThreeBodyProblem-earth">
      <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/earth.png" alt="Земля" class="ThreeBodyProblem-spin ThreeBodyProblem-bodyImage"/>
    </div>
    <div class="ThreeBodyProblem-jupiter">
      <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/jupiter_juno.png" alt="Юпитер" class="ThreeBodyProblem-spin ThreeBodyProblem-bodyImage" />
    </div>
    <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/center_of_mass.png" alt="Центр масс" class="ThreeBodyProblem-centerOfMass" />
    <canvas class="ThreeBodyProblem-canvas"></canvas>
    <div class="ThreeBodyProblem-hudContainer">
      <div class="ThreeBodyProblem-hudContainerChild">
      </div>
      
      <div class="ThreeBodyProblem-leftBottomButtonCantainer">
        <!-- ИСПРАВЛЕНО: Обновлена структура кнопок -->
        <a class="ThreeBodyProblem-leftBottomButton ThreeBodyProblem-mass1Button ThreeBodyProblem-doesChangeOpacityOnHover" href="#" title="Масса 1">
          <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/mass_one_icon.png" alt="Масса 1" class="ThreeBodyProblem-leftBottomImage mass-icon-image">
          <span class="mass-circle mass-icon-circle" style="background:#ff8b22"></span>
        </a>
        <a class="ThreeBodyProblem-leftBottomButton ThreeBodyProblem-mass2Button ThreeBodyProblem-doesChangeOpacityOnHover" href="#" title="Масса 2">
          <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/mass_two_icon.png" alt="Масса 2" class="ThreeBodyProblem-leftBottomImage mass-icon-image">
          <span class="mass-circle mass-icon-circle" style="background:#6c81ff"></span>
        </a>
        <a class="ThreeBodyProblem-leftBottomButton ThreeBodyProblem-mass3Button ThreeBodyProblem-doesChangeOpacityOnHover" href="#" title="Масса 3">
          <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/mass_three_icon.png" alt="Масса 3" class="ThreeBodyProblem-leftBottomImage mass-icon-image">
          <span class="mass-circle mass-icon-circle" style="background:#4ccd7a"></span>
        </a>
        <a class="ThreeBodyProblem-leftBottomButton ThreeBodyProblem-speedButton ThreeBodyProblem-doesChangeOpacityOnHover" href="#" title="Скорость">
          <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/clock_icon.png" alt="Скорость" class="ThreeBodyProblem-leftBottomImage">
        </a>
        <a class="ThreeBodyProblem-leftBottomButton ThreeBodyProblem-softeningButton ThreeBodyProblem-doesChangeOpacityOnHover" href="#" title="Смягчение">
          <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTguNSAxOC41YTYuNSA2LjUgMCAxIDAgMC0xMyIvPjxwYXRoIGQ9Ik01LjUgMTJoMTMiLz48L3N2Zz4=" alt="Смягчение" class="ThreeBodyProblem-leftBottomImage">
        </a>
        <a id="info-button" class="ThreeBodyProblem-leftBottomButton ThreeBodyProblem-doesChangeOpacityOnHover" href="#" title="Инструкция">
          <img src="https://www.nvdemarie.be/files/modules/products/53/Infobalie.png" alt="Инструкция" class="ThreeBodyProblem-leftBottomImage">
        </a>
      </div>
      
      <div class="ThreeBodyProblem-rightBottomButtonContainer">
          <button class="ThreeBodyProblem-pause ThreeBodyProblem-button">Пауза</button>
          <a class="ThreeBodyProblem-reload ThreeBodyProblem-doesChangeOpacityOnHover" href="#" title="Перезапуск">
            <img src="https://evgenii.com/image/blog/2016-09-17-ridiculous-strawberry-picking/reload_icon.png" alt="Перезапуск" class="ThreeBodyProblem-reloadIcon">
          </a>
      </div>
    </div>
  </div>
  
  <div class="ThreeBodyProblem-controlsArea">
    <div class="ThreeBodyProblem-isTextCentered ThreeBodyProblem-hasTopMarginSmall ThreeBodyProblem-hasNegativeBottomMarginNormal isUnselectable">
      <span class="ThreeBodyProblem-sliderLabel">0.01</span>
    </div>
    <div class="SickSlider ThreeBodyProblem-slider isUnselectable">
      <div class="SickSlider-stripe"></div>
      <div class="SickSlider-head"></div>
    </div>
    <div class="ThreeBodyProblem-isTextCentered">
      <button class="ThreeBodyProblem-preset ThreeBodyProblem-button ThreeBodyProblem-button--isSelected" data-name="FigureEight">Восьмёрка</button>
      <button class="ThreeBodyProblem-preset ThreeBodyProblem-button" data-name="SunEarthJupiter">Солнце, Земля и Юпитер</button>
      <button class="ThreeBodyProblem-preset ThreeBodyProblem-button" data-name="LagrangePoint5">Точка Лагранжа L5</button>
      <button class="ThreeBodyProblem-preset ThreeBodyProblem-button" data-name="Kepler16">Кеплер-16</button>
      <button class="ThreeBodyProblem-preset ThreeBodyProblem-button" data-name="Chaotic">Хаотический</button>
      <button class="ThreeBodyProblem-button" id="download-scene-button">Скачать сцену</button>
      <button class="ThreeBodyProblem-button" id="upload-scene-button">Загрузить сцену</button>
      <input type="file" id="scene-uploader" accept="application/json, .json" style="display: none;" />
    </div>
  </div>

  <div id="charts-container" style="max-width: 1100px; margin: 20px auto;">
    <details id="vel-details" style="margin-bottom: 10px;">
      <summary style="cursor:pointer; font-weight:600;">График скоростей (раскрыть/свернуть)</summary>
      <div style="width: 100%; height: 360px; margin-top: 10px;">
        <canvas id="velocityChart" style="width:100%; height:100%;"></canvas>
      </div>
    </details>
    <details id="eng-details" style="margin-bottom: 10px;">
      <summary style="cursor:pointer; font-weight:600;">График ускорений (раскрыть/свернуть)</summary>
      <div style="width: 100%; height: 360px; margin-top: 10px;">
        <canvas id="accelerationChart" style="width:100%; height:100%;"></canvas>
      </div>
    </details>
    <details id="approx-details">
      <summary style="cursor:pointer; font-weight:600;">Мгновенные аппроксимации траекторий (раскрыть/свернуть)</summary>
      <div id="approximation-display" class="approximation-display-style">
        <h4>Мгновенные аппроксимации траекторий</h4>
        <div style="text-align: center; margin-bottom: 15px;">
           <button class="ThreeBodyProblem-button" id="download-log-button">Скачать лог формул</button>
        </div>
        <pre id="formula-text-0"></pre>
        <pre id="formula-text-1"></pre>
        <pre id="formula-text-2"></pre>
      </div>
    </details>
  </div>

  <div id="info-modal" class="modal-overlay is-hidden">
    <div class="modal-content">
      <button class="modal-close-button" title="Закрыть">&times;</button>
      <div class="instruction-container">
        <!-- ИЗМЕНЕНИЕ НАЧАЛО -->
        <h2>Инструкция по использованию симулятора</h2>
        <p>
          Добро пожаловать в интерактивный симулятор задачи трёх тел! Эта программа позволяет моделировать движение трёх объектов в пространстве под действием их взаимного гравитационного притяжения.
        </p>

        <h3>Как пользоваться</h3>
        <ol>
          <li><strong>Выберите пресет:</strong> Начните с выбора одного из готовых сценариев в нижней части экрана (например, "Восьмёрка" или "Солнце, Земля и Юпитер"). Это установит начальные массы, положения и скорости тел.</li>
          <li><strong>Наблюдайте:</strong> Симуляция начнётся автоматически. Вы увидите, как тела движутся и оставляют за собой цветные траектории.</li>
          <li><strong>Экспериментируйте:</strong> Используйте элементы управления для изменения параметров симуляции в реальном времени.</li>
        </ol>

        <h3>Элементы управления</h3>
        <ul>
          <li><strong>Кнопки пресетов:</strong> ("Восьмёрка", "Солнце, Земля и Юпитер" и т.д.) — загружают предопределённые начальные условия.</li>
          <li><strong>Пауза / Продолжить:</strong> Приостанавливает или возобновляет симуляцию.</li>
          <li><strong>Перезапуск (иконка со стрелкой):</strong> Сбрасывает текущий пресет к его начальному состоянию.</li>
          <li><strong>Кнопки параметров (слева внизу):</strong>
            <ul>
              <li><strong>Масса 1, 2, 3:</strong> Нажмите на иконку, чтобы выбрать одно из тел для редактирования его массы с помощью слайдера.</li>
              <li><strong>Скорость (иконка с часами):</strong> Позволяет настроить скорость течения времени в симуляции.</li>
              <li><strong>Смягчение (иконка с полукругом):</strong> Регулирует параметр смягчения (ε), который предотвращает "гравитационный коллапс", когда тела подходят слишком близко друг к другу.</li>
            </ul>
          </li>
          <li><strong>Слайдер:</strong> Основной инструмент для изменения выбранного параметра. Просто перетаскивайте ползунок. Вы также можете <strong>нажать на текстовое значение над слайдером</strong>, чтобы ввести точное число с клавиатуры.</li>
          <li><strong>Скачать / Загрузить сцену:</strong> Эти кнопки позволяют сохранить текущее состояние симуляции (массы, положения, скорости) в файл на вашем компьютере и позже загрузить его для продолжения экспериментов.</li>
          <li><strong>Графики и аппроксимации:</strong> Ниже симуляции находятся раскрывающиеся секции, которые показывают графики скоростей и ускорений тел, а также выводят мгновенные формулы, аппроксимирующие их траектории. Лог этих формул можно скачать.</li>
        </ul>

        <h3>Описание пресетов</h3>
        <ul>
          <li><strong>Восьмёрка:</strong> Классическое устойчивое решение задачи трёх тел, где три тела с равными массами движутся по одной и той же траектории в форме восьмёрки.</li>
          <li><strong>Солнце, Земля и Юпитер:</strong> Упрощённая модель нашей Солнечной системы. Показывает, как массивный Юпитер влияет на орбиту Земли и на центр масс системы.</li>
          <li><strong>Точка Лагранжа L5:</strong> Демонстрирует одну из пяти точек стабильности в системе двух массивных тел (Солнце и Юпитер). Третье, менее массивное тело (астероид) может находиться в этой точке, двигаясь вместе с Юпитером.</li>
          <li><strong>Кеплер-16:</strong> Модель реальной экзопланетной системы Kepler-16, состоящей из двух звёзд, вращающихся друг вокруг друга, и планеты, которая вращается вокруг обеих звёзд.</li>
          <li><strong>Хаотический:</strong> Сценарий, который наглядно показывает "хаотичную" природу задачи. Небольшие изменения в начальных условиях могут привести к совершенно непредсказуемым и разным результатам.</li>
        </ul>
        <!-- ИЗМЕНЕНИЕ КОНЕЦ -->
      </div>
    </div>
  </div>

  <p class="ThreeBodyProblem-debugOutput"></p>

  <script src="script.js"></script>
  <script src="physics.js"></script>
  <script src="graphics.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="simulation.js"></script>
  <script src="ui.js"></script>

  <script>
    (function() {
      window.chartManager = {};
      const MAX_POINTS = 2000;
      let chartsInited = false;
      let velocityChart = null;
      let accelerationChart = null;
      let frameIndex = 0;
      function trimData(chart) {
        const d = chart.data;
        while (d.labels.length > MAX_POINTS) {
          d.labels.shift();
          chart.data.datasets.forEach(ds => ds.data.shift());
        }
      }
      function resetCharts() {
        if (!chartsInited) return;
        frameIndex = 0;
        velocityChart.data.labels = [];
        velocityChart.data.datasets.forEach(dataset => { dataset.data = []; });
        velocityChart.update('none');
        accelerationChart.data.labels = [];
        accelerationChart.data.datasets.forEach(dataset => { dataset.data = []; });
        accelerationChart.update('none');
      }
      window.chartManager.reset = resetCharts;
      function initCharts() {
        if (chartsInited) return;
        const velCanvas = document.getElementById('velocityChart');
        const accCanvas = document.getElementById('accelerationChart');
        if (!velCanvas || !accCanvas || !window.Chart) return;
        const velCtx = velCanvas.getContext('2d');
        const accCtx = accCanvas.getContext('2d');
        velocityChart = new Chart(velCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              { label: 'Скорость тела 1', data: [], borderColor: '#ff8b22', pointRadius: 0, tension: 0.1 },
              { label: 'Скорость тела 2', data: [], borderColor: '#6c81ff', pointRadius: 0, tension: 0.1 },
              { label: 'Скорость тела 3', data: [], borderColor: '#4ccd7a', pointRadius: 0, tension: 0.1 }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false, animation: false,
            interaction: { mode: 'nearest', intersect: false },
            plugins: { legend: { display: true }, tooltip: { enabled: true } },
            scales: {
              x: { title: { display: true, text: 'Шаг симуляции' }, ticks: { maxTicksLimit: 8 } },
              y: { title: { display: true, text: 'Скорость (|v|)' }, ticks: { maxTicksLimit: 8 } }
            }
          }
        });
        accelerationChart = new Chart(accCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              { label: 'Ускорение тела 1', data: [], borderColor: '#ff8b22', pointRadius: 0, tension: 0.1 },
              { label: 'Ускорение тела 2', data: [], borderColor: '#6c81ff', pointRadius: 0, tension: 0.1 },
              { label: 'Ускорение тела 3', data: [], borderColor: '#4ccd7a', pointRadius: 0, tension: 0.1 }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false, animation: false,
            interaction: { mode: 'nearest', intersect: false },
            plugins: { legend: { display: true }, tooltip: { enabled: true } },
            scales: {
              x: { title: { display: true, text: 'Шаг симуляции' }, ticks: { maxTicksLimit: 8 } },
              y: { title: { display: true, text: 'Ускорение (|a|)' }, ticks: { maxTicksLimit: 8 } }
            }
          }
        });
        chartsInited = true;
        document.getElementById('vel-details')?.addEventListener('toggle', () => setTimeout(() => velocityChart?.resize(), 0));
        document.getElementById('eng-details')?.addEventListener('toggle', () => setTimeout(() => accelerationChart?.resize(), 0));
        window.addEventListener('resize', () => {
          velocityChart?.resize();
          accelerationChart?.resize();
        });
      }
      function updateCharts() {
        if (window.simulation && typeof simulation.isPaused === 'function' && simulation.isPaused()) {
          requestAnimationFrame(updateCharts);
          return;
        }
        if (window.physics && typeof physics.getSpeeds === 'function' && typeof physics.getAccelerations === 'function') {
          if (!chartsInited) initCharts();
          if (chartsInited) {
            const speeds = physics.getSpeeds();
            const totalSpeed = speeds.reduce((sum, speed) => sum + (speed || 0), 0);
            
            if (totalSpeed > 0) {
              const accelerations = physics.getAccelerations();
              frameIndex += 1;
              const label = String(frameIndex);

              velocityChart.data.labels.push(label);
              for (let i = 0; i < 3; i++) {
                velocityChart.data.datasets[i].data.push(speeds[i] ?? null);
              }
              trimData(velocityChart);
              velocityChart.update('none');

              accelerationChart.data.labels.push(label);
              for (let i = 0; i < 3; i++) {
                const accMagnitude = accelerations[i] ? Math.sqrt(accelerations[i].ax**2 + accelerations[i].ay**2) : null;
                accelerationChart.data.datasets[i].data.push(accMagnitude);
              }
              trimData(accelerationChart);
              accelerationChart.update('none');
            }
          }
        }
        requestAnimationFrame(updateCharts);
      }
      window.addEventListener('load', () => {
        initCharts();
        requestAnimationFrame(updateCharts);
      });
    })();
  </script>

</body>
</html>
